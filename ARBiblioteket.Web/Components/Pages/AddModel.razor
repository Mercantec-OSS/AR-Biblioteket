@page "/add_model"
@using ARBiblioteket.ApiService.Services
@using ARBiblioteket.ApiService
@inject ApiService ApiService

<PageTitle>AR Biblioteket - Tilføj 3D Model</PageTitle>

<div class="container">
    <p>Tilføj 3D model</p>
    <EditForm Model="@modelData" OnValidSubmit="HandleSubmit">
        <DataAnnotationsValidator />
        <ValidationSummary />

        <div class="section">
            <label>Title</label>
            <InputText @bind-Value="modelData.Title" placeholder="Title" class="form-control" />
        </div>
        <div class="section">
            <label>Uddannelse</label>
            <InputSelect @bind-Value="modelData.Education" class="form-control">
                <option value="">Vælg uddannelse</option>
                <option value="Auto">Auto</option>
                <option value="Automatik">Automatik</option>
                <option value="Business">Business</option>
                <option value="Data">Data</option>
                <option value="Elektriker">Elektriker</option>
                <option value="Elektronik">Elektronik</option>
                <option value="Gastronomi">Gastronomi</option>
                <option value="Industriteknik">Industriteknik</option>
                <option value="Operatør">Operatør</option>
                <option value="Produktør">Produktør</option>
                <option value="Smed">Smed</option>
                <option value="Struktør">Struktør</option>
                <option value="Tømrer">Tømrer</option>
                <option value="VVS">VVS</option>
            </InputSelect>
        </div>
        <div class="section">
            <label>Beskrivelse</label>
            <InputTextArea @bind-Value="modelData.Description" placeholder="Beskrivelse" class="form-control" />
        </div>
        <div class="section">
            <label>3D Model</label>
            <InputFile OnChange="HandleFileUpload" />
        </div>
        <div class="section">
            <label>Billede</label>
            <InputFile OnChange="HandleImageUpload" />
        </div>
        <button class="btn btn-primary">Tilføj</button>
    </EditForm>
</div>

@code {
    private ModelCreateDto modelData = new();
    private IBrowserFile? selected3DModel;
    private IBrowserFile? selectedImage;

    private async Task HandleFileUpload(InputFileChangeEventArgs e)
    {
        selected3DModel = e.File;
    }

    private async Task HandleImageUpload(InputFileChangeEventArgs e)
    {
        selectedImage = e.File;
    }

    private async Task HandleSubmit()
    {
        try
        {
            if (selected3DModel != null && selectedImage != null)
            {
                var modelPath = Path.Combine("wwwroot", "LocalModels", selected3DModel.Name);
                var imagePath = Path.Combine("wwwroot", "LocalImages", selectedImage.Name);

                // Save the 3D model file
                await using (var fileStream = new FileStream(modelPath, FileMode.Create))
                {
                    await selected3DModel.OpenReadStream().CopyToAsync(fileStream);
                }

                // Save the image file
                await using (var fileStream = new FileStream(imagePath, FileMode.Create))
                {
                    await selectedImage.OpenReadStream().CopyToAsync(fileStream);
                }

                // Set relative paths for the database
                modelData.ThreeDFile = Path.Combine("LocalModels", selected3DModel.Name);
                modelData.ImageFile = Path.Combine("LocalImages", selectedImage.Name);

                // Call API to save the model data
                var result = await ApiService.CreateModelAsync(modelData);
                if (result != null)
                {
                    Console.WriteLine($"Success: Model created. 3D File Path: {modelData.ThreeDFile}, Image File Path: {modelData.ImageFile}");
                }
                else
                {
                    Console.WriteLine("Error: Failed to save the model in the database.");
                }
            }
            else
            {
                Console.WriteLine("Error: Missing files. Please upload both a 3D model and an image.");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error: {ex.Message}");
        }
    }
}
